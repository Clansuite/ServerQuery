name: Generate API Documentation

on:
  # This workflows runs on pushes to the main branch.
  push:
    branches: [ main ]
    # This workflows runs only when files in 'src' or 'bin' directories are changed.
    paths:
      - 'src/**'
      - 'bin/**'
  # You can manually run this workflow.
  workflow_dispatch:

jobs:

# ---------------------------------------------------------------------------------------

  apigen:

# ---------------------------------------------------------------------------------------

    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source

    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5 # https://github.com/actions/checkout/

    - name: Setup PHP
      uses: shivammathur/setup-php@v2 # https://github.com/shivammathur/setup-php
      with:
        php-version: '8.2'
        extensions: mbstring, intl, zip

    - name: Install dependencies
      run: |
        cd build-tools/apigen
        composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Generate API documentation
      run: |
        php bin/generate_apigen_docs.php

    - name: Move generated docs into subfolder
      run: |
        mkdir -p ./build/apigen/apigen
        mv ./build-tools/apigen/* ./build/apigen/apigen

    - name: Create top-level Index file
      run: |
        cat > build/apigen/index.md <<'EOF'
        ---
        layout: none
        ---
        <meta http-equiv="refresh" content="0; url=./apigen/">
        <p>Redirecting to <a href="./apigen/">API documentation</a>.</p>
        EOF

    - name: Create .nojekyll file to disable Jekyll processing
      run: |
        touch build/apigen/.nojekyll

    - name: Upload pages artifact
      uses: actions/upload-pages-artifact@v4 # https://github.com/actions/upload-pages-artifact/
      with:
        path: ./build/apigen

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4 # https://github.com/actions/deploy-pages/
